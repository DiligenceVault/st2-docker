version: 2.1
jobs:
  # Verify docker-compose.yml format for any immediate linting issues
  docker-compose-lint:
    docker:
      - image: docker/compose:latest
    steps:
      - checkout
      - run:
          name: Docker-compose lint check
          command: docker-compose config

  # Run docker-compose install and verify st2 deployment
  docker-compose-up:
    working_directory: ~/docker
    machine:
      # Available images https://circleci.com/docs/2.0/configuration-reference/#available-machine-images
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run:
          name: Pull Docker Images
          command: docker-compose pull
      - run:
          name: Start StackStorm in docker-compose
          command: docker-compose up --detach
      - run:
          when: always
          name: List created Services
          command: docker-compose ps
      - run:
          name: Smoke-test StackStorm cluster
          command: |
            # TODO: Replace with more organized BATS tests
            # Example: https://github.com/StackStorm/stackstorm-ha/blob/master/tests/st2tests.sh
            docker-compose exec st2client st2 action list --pack=core
            docker-compose exec st2client st2 run core.local cmd=date
            docker-compose exec st2client st2 pack install github
            docker-compose exec st2client st2 execution list

workflows:
  version: 2
  docker-compose:
    jobs:
      - docker-compose-lint
      - docker-compose-up:
          requires:
            - docker-compose-lint

  # Nightly run docker-compose install and ensure no regressions for st2 deployment in 'master' branch
  docker-compose-nightly:
    jobs:
      - docker-compose-lint
      - docker-compose-up:
          requires:
            - docker-compose-lint
    triggers:
      - schedule:
          cron: "0 1 * * *"
          filters:
            branches:
              only:
                - master

experimental:
  notify:
    branches:
      only:
        - master
